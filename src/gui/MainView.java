/*********************************************************************
 *
 *  TodoListManager - Open-source manager of todo lists
 *
 *  Copyright (C) 2019
 *
 *  This file is part of TodoListManager.
 *
 *  TodoListManager is free software: you can redistribute it and/or modify
 *  it under the terms of the GNU Affero General Public License as published by
 *  the Free Software Foundation, either version 3 of the License, or
 *  (at your option) any later version.
 *
 *  TodoListManager is distributed in the hope that it will be useful,
 *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 *  GNU Affero General Public License for more details.
 *
 *  You should have received a copy of the GNU Affero General Public License
 *  along with TodoListManager.  If not, see <http://www.gnu.org/licenses/>.
 *
 *  Contact: Lluís Alemany Puig (lluis.alemany.puig@gmail.com)
 *
 ********************************************************************/

package gui;

import java.awt.Dimension;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.awt.event.MouseAdapter;
import java.awt.event.MouseEvent;
import java.awt.event.WindowAdapter;
import java.awt.event.WindowEvent;
import java.io.File;
import java.io.FileWriter;
import java.io.IOException;
import java.nio.file.Paths;
import java.util.ArrayList;
import java.util.Collections;
import java.util.logging.Level;
import javax.swing.Box;
import javax.swing.GroupLayout;
import javax.swing.JButton;
import javax.swing.JDialog;
import javax.swing.Timer;
import javax.swing.JFileChooser;
import javax.swing.JLabel;
import javax.swing.JMenu;
import javax.swing.JMenuBar;
import javax.swing.JMenuItem;
import javax.swing.tree.DefaultMutableTreeNode;
import javax.swing.tree.DefaultTreeModel;
import javax.swing.tree.TreePath;
import javax.swing.JOptionPane;
import javax.swing.JPanel;
import javax.swing.JPopupMenu;
import javax.swing.JScrollPane;
import javax.swing.JTextArea;
import javax.swing.JTextField;
import javax.swing.JToolBar;
import javax.swing.JTree;
import javax.swing.LayoutStyle;
import javax.swing.SwingConstants;
import javax.swing.WindowConstants;
import javax.swing.event.TreeSelectionEvent;
import javax.swing.event.TreeSelectionListener;
import javax.swing.filechooser.FileNameExtensionFilter;
import javax.swing.tree.TreeSelectionModel;

import todomanager.task.*;
import todomanager.util.Logger;
import todomanager.util.SystemInfo;
import todomanager.util.Tools;
import todomanager.util.Translate;

/**
 * @brief Main class: the only file that defines the Graphical User Interface.
 * @author Lluís Alemany Puig
 */
public class MainView extends javax.swing.JFrame {

	private final DefaultTreeModel treeModel;
	private final DefaultMutableTreeNode highPriorNode;
	private final DefaultMutableTreeNode medPriorNode;
	private final DefaultMutableTreeNode lowPriorNode;
	private final Logger log;
	private boolean changesSaved;
	private String authorName;
	
	private String lockFileName = null;
	private File lockFile = null;
	
	public MainView() {
		// instantiate the System Info singleton before anything else...
		SystemInfo sysinfo = SystemInfo.getInstance();
		// Instance logger (this uses the SystemInfo)
		log = Logger.getInstance();
		log.begin();
		// extract the rest of the information needed from the system
		sysinfo.extractSystemInfo();
		// print useful information for the user to see in case of bugs.
		log.printSystemInformation();
		
		initComponents();
		
		treeModel = (DefaultTreeModel) (treeTasks.getModel());
		DefaultMutableTreeNode root = (DefaultMutableTreeNode) treeModel.getRoot();
		highPriorNode = (DefaultMutableTreeNode) root.getChildAt(0);
		medPriorNode = (DefaultMutableTreeNode) root.getChildAt(1);
		lowPriorNode = (DefaultMutableTreeNode) root.getChildAt(2);
		
		treeTasks.getSelectionModel().setSelectionMode(TreeSelectionModel.SINGLE_TREE_SELECTION);
		
		CustomTreeCellRenderer renderer = new CustomTreeCellRenderer(14);
		treeTasks.setCellRenderer(renderer);
		
		setChangesSaved();
		
		setTextToComponents();
	}

	/**
	 * This method is called from within the constructor to initialize the form.
	 * WARNING: Do NOT modify this code. The content of this method is always
	 * regenerated by the Form Editor.
	 */
	@SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        jPanel3 = new JPanel();
        jScrollPane6 = new JScrollPane();
        treeTasks = new JTree();
        jPanel2 = new JPanel();
        buttonRemoveTask = new JButton();
        buttonNewTask = new JButton();
        buttonTaskDown = new JButton();
        buttonTaskUp = new JButton();
        buttonIncrPriority = new JButton();
        buttonDecrPriority = new JButton();
        buttonShowAll = new JButton();
        buttonHideAll = new JButton();
        textBoxError = new JTextField();
        jPanel7 = new JPanel();
        jPanel5 = new JPanel();
        buttonTaskWorking = new JButton();
        buttonTaskCancel = new JButton();
        buttonTaskDone = new JButton();
        buttonTaskDelete = new JButton();
        buttonTaskOnRevision = new JButton();
        buttonTaskHold = new JButton();
        buttonTaskPendingRevision = new JButton();
        buttonTaskEdit = new JButton();
        buttonTaskClear = new JButton();
        jPanel1 = new JPanel();
        labelTaskState = new JLabel();
        textBoxTaskDate = new JTextField();
        labelTaskID = new JLabel();
        textBoxTaskName = new JTextField();
        labelTaskName = new JLabel();
        labelTaskDate = new JLabel();
        jScrollPane1 = new JScrollPane();
        textAreaTaskChanges = new JTextArea();
        labelTaskDescription = new JLabel();
        jLabel6 = new JLabel();
        jScrollPane7 = new JScrollPane();
        textAreaTaskDescription = new JTextArea();
        labelTaskHistory = new JLabel();
        textBoxTaskAuthor = new JTextField();
        labelTaskAuthor = new JLabel();
        labelTaskStateText = new JLabel();
        jToolBar1 = new JToolBar();
        buttonOpenTasks = new JButton();
        buttonSaveTasks = new JButton();
        buttonSaveTasksAs = new JButton();
        jSeparator2 = new JToolBar.Separator();
        buttonSetAuthor = new JButton();
        filler1 = new Box.Filler(new Dimension(10, 0), new Dimension(10, 0), new Dimension(10, 32767));
        labelAuthorName = new JLabel();
        jSeparator3 = new JToolBar.Separator();
        labelUnsavedChanges = new JLabel();
        jMenuBar1 = new JMenuBar();
        menuItemFile = new JMenu();
        menuItemOpenFile = new JMenuItem();
        menuItemSaveTasks = new JMenuItem();
        menuItemSaveTasksAs = new JMenuItem();
        jSeparator1 = new JPopupMenu.Separator();
        menuItemExit = new JMenuItem();
        menuItemHelp = new JMenu();
        menuItemAbout = new JMenuItem();

        setDefaultCloseOperation(WindowConstants.EXIT_ON_CLOSE);
        setTitle("Todo List Manager");
        setMinimumSize(new Dimension(1133, 0));
        addWindowListener(new WindowAdapter() {
            public void windowClosing(WindowEvent evt) {
                formWindowClosing(evt);
            }
        });

        DefaultMutableTreeNode treeNode1 = new DefaultMutableTreeNode("Tasks");
        DefaultMutableTreeNode treeNode2 = new DefaultMutableTreeNode("High Priority");
        treeNode1.add(treeNode2);
        treeNode2 = new DefaultMutableTreeNode("Medium Priority");
        treeNode1.add(treeNode2);
        treeNode2 = new DefaultMutableTreeNode("Low Priority");
        treeNode1.add(treeNode2);
        treeTasks.setModel(new DefaultTreeModel(treeNode1));
        treeTasks.setRootVisible(false);
        treeTasks.addTreeSelectionListener(new TreeSelectionListener() {
            public void valueChanged(TreeSelectionEvent evt) {
                treeTasksValueChanged(evt);
            }
        });
        jScrollPane6.setViewportView(treeTasks);

        buttonRemoveTask.setText("Remove");
        buttonRemoveTask.addMouseListener(new MouseAdapter() {
            public void mouseClicked(MouseEvent evt) {
                buttonRemoveTaskMouseClicked(evt);
            }
        });

        buttonNewTask.setText("New Task");
        buttonNewTask.addMouseListener(new MouseAdapter() {
            public void mouseClicked(MouseEvent evt) {
                buttonNewTaskMouseClicked(evt);
            }
        });

        buttonTaskDown.setText("Down");
        buttonTaskDown.addMouseListener(new MouseAdapter() {
            public void mouseClicked(MouseEvent evt) {
                buttonTaskDownMouseClicked(evt);
            }
        });

        buttonTaskUp.setText("Up");
        buttonTaskUp.addMouseListener(new MouseAdapter() {
            public void mouseClicked(MouseEvent evt) {
                buttonTaskUpMouseClicked(evt);
            }
        });

        buttonIncrPriority.setText("+ Priority");
        buttonIncrPriority.addMouseListener(new MouseAdapter() {
            public void mouseClicked(MouseEvent evt) {
                buttonIncrPriorityMouseClicked(evt);
            }
        });

        buttonDecrPriority.setText("- Priority");
        buttonDecrPriority.addMouseListener(new MouseAdapter() {
            public void mouseClicked(MouseEvent evt) {
                buttonDecrPriorityMouseClicked(evt);
            }
        });

        buttonShowAll.setText("Show all");
        buttonShowAll.addMouseListener(new MouseAdapter() {
            public void mouseClicked(MouseEvent evt) {
                buttonShowAllMouseClicked(evt);
            }
        });

        buttonHideAll.setText("Hide all");
        buttonHideAll.addMouseListener(new MouseAdapter() {
            public void mouseClicked(MouseEvent evt) {
                buttonHideAllMouseClicked(evt);
            }
        });

        GroupLayout jPanel2Layout = new GroupLayout(jPanel2);
        jPanel2.setLayout(jPanel2Layout);
        jPanel2Layout.setHorizontalGroup(jPanel2Layout.createParallelGroup(GroupLayout.Alignment.LEADING)
            .addGroup(jPanel2Layout.createSequentialGroup()
                .addContainerGap(GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                .addGroup(jPanel2Layout.createParallelGroup(GroupLayout.Alignment.LEADING)
                    .addGroup(GroupLayout.Alignment.TRAILING, jPanel2Layout.createSequentialGroup()
                        .addComponent(buttonNewTask, GroupLayout.PREFERRED_SIZE, 90, GroupLayout.PREFERRED_SIZE)
                        .addPreferredGap(LayoutStyle.ComponentPlacement.RELATED)
                        .addComponent(buttonTaskUp, GroupLayout.PREFERRED_SIZE, 90, GroupLayout.PREFERRED_SIZE)
                        .addPreferredGap(LayoutStyle.ComponentPlacement.RELATED)
                        .addComponent(buttonIncrPriority, GroupLayout.PREFERRED_SIZE, 90, GroupLayout.PREFERRED_SIZE)
                        .addPreferredGap(LayoutStyle.ComponentPlacement.RELATED)
                        .addComponent(buttonShowAll, GroupLayout.PREFERRED_SIZE, 90, GroupLayout.PREFERRED_SIZE))
                    .addGroup(GroupLayout.Alignment.TRAILING, jPanel2Layout.createSequentialGroup()
                        .addComponent(buttonRemoveTask, GroupLayout.PREFERRED_SIZE, 90, GroupLayout.PREFERRED_SIZE)
                        .addPreferredGap(LayoutStyle.ComponentPlacement.RELATED)
                        .addComponent(buttonTaskDown, GroupLayout.PREFERRED_SIZE, 90, GroupLayout.PREFERRED_SIZE)
                        .addPreferredGap(LayoutStyle.ComponentPlacement.RELATED)
                        .addComponent(buttonDecrPriority, GroupLayout.PREFERRED_SIZE, 90, GroupLayout.PREFERRED_SIZE)
                        .addPreferredGap(LayoutStyle.ComponentPlacement.RELATED)
                        .addComponent(buttonHideAll, GroupLayout.PREFERRED_SIZE, 90, GroupLayout.PREFERRED_SIZE)))
                .addContainerGap())
        );
        jPanel2Layout.setVerticalGroup(jPanel2Layout.createParallelGroup(GroupLayout.Alignment.LEADING)
            .addGroup(GroupLayout.Alignment.TRAILING, jPanel2Layout.createSequentialGroup()
                .addContainerGap()
                .addGroup(jPanel2Layout.createParallelGroup(GroupLayout.Alignment.BASELINE)
                    .addComponent(buttonNewTask)
                    .addComponent(buttonTaskUp)
                    .addComponent(buttonIncrPriority)
                    .addComponent(buttonShowAll))
                .addPreferredGap(LayoutStyle.ComponentPlacement.RELATED)
                .addGroup(jPanel2Layout.createParallelGroup(GroupLayout.Alignment.BASELINE)
                    .addComponent(buttonHideAll)
                    .addComponent(buttonDecrPriority)
                    .addComponent(buttonTaskDown)
                    .addComponent(buttonRemoveTask))
                .addContainerGap(GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
        );

        GroupLayout jPanel3Layout = new GroupLayout(jPanel3);
        jPanel3.setLayout(jPanel3Layout);
        jPanel3Layout.setHorizontalGroup(jPanel3Layout.createParallelGroup(GroupLayout.Alignment.LEADING)
            .addGroup(jPanel3Layout.createSequentialGroup()
                .addContainerGap()
                .addGroup(jPanel3Layout.createParallelGroup(GroupLayout.Alignment.LEADING)
                    .addComponent(jScrollPane6)
                    .addComponent(jPanel2, GroupLayout.DEFAULT_SIZE, GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
                .addContainerGap())
        );
        jPanel3Layout.setVerticalGroup(jPanel3Layout.createParallelGroup(GroupLayout.Alignment.LEADING)
            .addGroup(jPanel3Layout.createSequentialGroup()
                .addContainerGap()
                .addComponent(jScrollPane6, GroupLayout.PREFERRED_SIZE, 643, GroupLayout.PREFERRED_SIZE)
                .addPreferredGap(LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(jPanel2, GroupLayout.DEFAULT_SIZE, GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                .addContainerGap())
        );

        buttonTaskWorking.setText("Working");
        buttonTaskWorking.addMouseListener(new MouseAdapter() {
            public void mouseClicked(MouseEvent evt) {
                buttonTaskWorkingMouseClicked(evt);
            }
        });

        buttonTaskCancel.setText("Cancel");
        buttonTaskCancel.addMouseListener(new MouseAdapter() {
            public void mouseClicked(MouseEvent evt) {
                buttonTaskCancelMouseClicked(evt);
            }
        });

        buttonTaskDone.setText("Done");
        buttonTaskDone.addMouseListener(new MouseAdapter() {
            public void mouseClicked(MouseEvent evt) {
                buttonTaskDoneMouseClicked(evt);
            }
        });

        buttonTaskDelete.setText("Delete");
        buttonTaskDelete.addMouseListener(new MouseAdapter() {
            public void mouseClicked(MouseEvent evt) {
                buttonTaskDeleteMouseClicked(evt);
            }
        });

        buttonTaskOnRevision.setText("On revision");
        buttonTaskOnRevision.addMouseListener(new MouseAdapter() {
            public void mouseClicked(MouseEvent evt) {
                buttonTaskOnRevisionMouseClicked(evt);
            }
        });

        buttonTaskHold.setText("Put on Hold");
        buttonTaskHold.addMouseListener(new MouseAdapter() {
            public void mouseClicked(MouseEvent evt) {
                buttonTaskHoldMouseClicked(evt);
            }
        });

        buttonTaskPendingRevision.setText("Pending revision");
        buttonTaskPendingRevision.addMouseListener(new MouseAdapter() {
            public void mouseClicked(MouseEvent evt) {
                buttonTaskPendingRevisionMouseClicked(evt);
            }
        });

        buttonTaskEdit.setText("Edit Task");
        buttonTaskEdit.setEnabled(false);
        buttonTaskEdit.addMouseListener(new MouseAdapter() {
            public void mouseClicked(MouseEvent evt) {
                buttonTaskEditMouseClicked(evt);
            }
        });

        buttonTaskClear.setText("Clear");
        buttonTaskClear.addMouseListener(new MouseAdapter() {
            public void mouseClicked(MouseEvent evt) {
                buttonTaskClearMouseClicked(evt);
            }
        });

        GroupLayout jPanel5Layout = new GroupLayout(jPanel5);
        jPanel5.setLayout(jPanel5Layout);
        jPanel5Layout.setHorizontalGroup(jPanel5Layout.createParallelGroup(GroupLayout.Alignment.LEADING)
            .addGroup(GroupLayout.Alignment.TRAILING, jPanel5Layout.createSequentialGroup()
                .addGap(94, 94, 94)
                .addGroup(jPanel5Layout.createParallelGroup(GroupLayout.Alignment.LEADING)
                    .addGroup(jPanel5Layout.createSequentialGroup()
                        .addComponent(buttonTaskHold, GroupLayout.PREFERRED_SIZE, 130, GroupLayout.PREFERRED_SIZE)
                        .addPreferredGap(LayoutStyle.ComponentPlacement.RELATED)
                        .addComponent(buttonTaskEdit, GroupLayout.PREFERRED_SIZE, 130, GroupLayout.PREFERRED_SIZE)
                        .addPreferredGap(LayoutStyle.ComponentPlacement.RELATED)
                        .addComponent(buttonTaskClear, GroupLayout.PREFERRED_SIZE, 130, GroupLayout.PREFERRED_SIZE))
                    .addGroup(jPanel5Layout.createSequentialGroup()
                        .addComponent(buttonTaskDone, GroupLayout.PREFERRED_SIZE, 130, GroupLayout.PREFERRED_SIZE)
                        .addPreferredGap(LayoutStyle.ComponentPlacement.RELATED)
                        .addComponent(buttonTaskOnRevision, GroupLayout.PREFERRED_SIZE, 130, GroupLayout.PREFERRED_SIZE)
                        .addPreferredGap(LayoutStyle.ComponentPlacement.RELATED)
                        .addComponent(buttonTaskCancel, GroupLayout.PREFERRED_SIZE, 130, GroupLayout.PREFERRED_SIZE))
                    .addGroup(jPanel5Layout.createSequentialGroup()
                        .addComponent(buttonTaskWorking, GroupLayout.PREFERRED_SIZE, 130, GroupLayout.PREFERRED_SIZE)
                        .addPreferredGap(LayoutStyle.ComponentPlacement.RELATED)
                        .addComponent(buttonTaskPendingRevision, GroupLayout.PREFERRED_SIZE, 130, GroupLayout.PREFERRED_SIZE)
                        .addPreferredGap(LayoutStyle.ComponentPlacement.RELATED)
                        .addComponent(buttonTaskDelete, GroupLayout.PREFERRED_SIZE, 130, GroupLayout.PREFERRED_SIZE)))
                .addContainerGap(GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
        );
        jPanel5Layout.setVerticalGroup(jPanel5Layout.createParallelGroup(GroupLayout.Alignment.LEADING)
            .addGroup(jPanel5Layout.createSequentialGroup()
                .addContainerGap()
                .addGroup(jPanel5Layout.createParallelGroup(GroupLayout.Alignment.BASELINE)
                    .addComponent(buttonTaskDone)
                    .addComponent(buttonTaskOnRevision)
                    .addComponent(buttonTaskCancel))
                .addPreferredGap(LayoutStyle.ComponentPlacement.RELATED)
                .addGroup(jPanel5Layout.createParallelGroup(GroupLayout.Alignment.BASELINE)
                    .addComponent(buttonTaskPendingRevision)
                    .addComponent(buttonTaskDelete)
                    .addComponent(buttonTaskWorking))
                .addPreferredGap(LayoutStyle.ComponentPlacement.RELATED)
                .addGroup(jPanel5Layout.createParallelGroup(GroupLayout.Alignment.BASELINE)
                    .addComponent(buttonTaskHold)
                    .addComponent(buttonTaskEdit)
                    .addComponent(buttonTaskClear))
                .addContainerGap(GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
        );

        labelTaskState.setHorizontalAlignment(SwingConstants.CENTER);
        labelTaskState.setText("-");

        textBoxTaskDate.setEditable(false);

        labelTaskID.setHorizontalAlignment(SwingConstants.CENTER);
        labelTaskID.setText("000000");

        textBoxTaskName.setEditable(false);

        labelTaskName.setText("Name");

        labelTaskDate.setText("Date");

        textAreaTaskChanges.setEditable(false);
        textAreaTaskChanges.setColumns(20);
        textAreaTaskChanges.setLineWrap(true);
        textAreaTaskChanges.setRows(5);
        jScrollPane1.setViewportView(textAreaTaskChanges);

        labelTaskDescription.setText("Description");

        jLabel6.setText("id:");

        textAreaTaskDescription.setEditable(false);
        textAreaTaskDescription.setColumns(20);
        textAreaTaskDescription.setLineWrap(true);
        textAreaTaskDescription.setRows(8);
        textAreaTaskDescription.setTabSize(4);
        jScrollPane7.setViewportView(textAreaTaskDescription);

        labelTaskHistory.setText("History");

        textBoxTaskAuthor.setEditable(false);

        labelTaskAuthor.setText("Author");

        labelTaskStateText.setText("State:");

        GroupLayout jPanel1Layout = new GroupLayout(jPanel1);
        jPanel1.setLayout(jPanel1Layout);
        jPanel1Layout.setHorizontalGroup(jPanel1Layout.createParallelGroup(GroupLayout.Alignment.LEADING)
            .addGroup(jPanel1Layout.createSequentialGroup()
                .addContainerGap()
                .addGroup(jPanel1Layout.createParallelGroup(GroupLayout.Alignment.LEADING)
                    .addComponent(labelTaskDescription)
                    .addComponent(labelTaskHistory)
                    .addComponent(labelTaskDate)
                    .addComponent(labelTaskName)
                    .addComponent(labelTaskAuthor))
                .addPreferredGap(LayoutStyle.ComponentPlacement.RELATED)
                .addGroup(jPanel1Layout.createParallelGroup(GroupLayout.Alignment.LEADING)
                    .addComponent(jScrollPane1, GroupLayout.DEFAULT_SIZE, 545, Short.MAX_VALUE)
                    .addComponent(jScrollPane7, GroupLayout.Alignment.TRAILING)
                    .addComponent(textBoxTaskName)
                    .addGroup(GroupLayout.Alignment.TRAILING, jPanel1Layout.createSequentialGroup()
                        .addGroup(jPanel1Layout.createParallelGroup(GroupLayout.Alignment.LEADING)
                            .addComponent(textBoxTaskDate)
                            .addComponent(textBoxTaskAuthor))
                        .addPreferredGap(LayoutStyle.ComponentPlacement.RELATED)
                        .addGroup(jPanel1Layout.createParallelGroup(GroupLayout.Alignment.LEADING)
                            .addComponent(jLabel6, GroupLayout.Alignment.TRAILING)
                            .addComponent(labelTaskStateText, GroupLayout.Alignment.TRAILING))
                        .addPreferredGap(LayoutStyle.ComponentPlacement.RELATED)
                        .addGroup(jPanel1Layout.createParallelGroup(GroupLayout.Alignment.LEADING, false)
                            .addComponent(labelTaskID, GroupLayout.DEFAULT_SIZE, 85, Short.MAX_VALUE)
                            .addComponent(labelTaskState, GroupLayout.DEFAULT_SIZE, GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))))
                .addContainerGap())
        );
        jPanel1Layout.setVerticalGroup(jPanel1Layout.createParallelGroup(GroupLayout.Alignment.LEADING)
            .addGroup(jPanel1Layout.createSequentialGroup()
                .addContainerGap()
                .addGroup(jPanel1Layout.createParallelGroup(GroupLayout.Alignment.BASELINE)
                    .addComponent(textBoxTaskName, GroupLayout.PREFERRED_SIZE, GroupLayout.DEFAULT_SIZE, GroupLayout.PREFERRED_SIZE)
                    .addComponent(labelTaskName))
                .addPreferredGap(LayoutStyle.ComponentPlacement.RELATED)
                .addGroup(jPanel1Layout.createParallelGroup(GroupLayout.Alignment.BASELINE)
                    .addComponent(textBoxTaskAuthor, GroupLayout.PREFERRED_SIZE, GroupLayout.DEFAULT_SIZE, GroupLayout.PREFERRED_SIZE)
                    .addComponent(labelTaskAuthor)
                    .addComponent(labelTaskID)
                    .addComponent(jLabel6))
                .addPreferredGap(LayoutStyle.ComponentPlacement.RELATED)
                .addGroup(jPanel1Layout.createParallelGroup(GroupLayout.Alignment.BASELINE)
                    .addComponent(textBoxTaskDate, GroupLayout.PREFERRED_SIZE, GroupLayout.DEFAULT_SIZE, GroupLayout.PREFERRED_SIZE)
                    .addComponent(labelTaskDate)
                    .addComponent(labelTaskStateText)
                    .addComponent(labelTaskState, GroupLayout.PREFERRED_SIZE, 26, GroupLayout.PREFERRED_SIZE))
                .addGap(9, 9, 9)
                .addGroup(jPanel1Layout.createParallelGroup(GroupLayout.Alignment.LEADING)
                    .addComponent(jScrollPane7, GroupLayout.DEFAULT_SIZE, 210, Short.MAX_VALUE)
                    .addGroup(jPanel1Layout.createSequentialGroup()
                        .addComponent(labelTaskDescription)
                        .addGap(0, 0, Short.MAX_VALUE)))
                .addPreferredGap(LayoutStyle.ComponentPlacement.RELATED)
                .addGroup(jPanel1Layout.createParallelGroup(GroupLayout.Alignment.LEADING)
                    .addComponent(labelTaskHistory)
                    .addComponent(jScrollPane1, GroupLayout.PREFERRED_SIZE, 302, GroupLayout.PREFERRED_SIZE)))
        );

        GroupLayout jPanel7Layout = new GroupLayout(jPanel7);
        jPanel7.setLayout(jPanel7Layout);
        jPanel7Layout.setHorizontalGroup(jPanel7Layout.createParallelGroup(GroupLayout.Alignment.LEADING)
            .addGroup(jPanel7Layout.createSequentialGroup()
                .addContainerGap()
                .addGroup(jPanel7Layout.createParallelGroup(GroupLayout.Alignment.LEADING)
                    .addGroup(jPanel7Layout.createSequentialGroup()
                        .addComponent(jPanel1, GroupLayout.PREFERRED_SIZE, GroupLayout.DEFAULT_SIZE, GroupLayout.PREFERRED_SIZE)
                        .addGap(0, 0, Short.MAX_VALUE))
                    .addComponent(jPanel5, GroupLayout.Alignment.TRAILING, GroupLayout.DEFAULT_SIZE, GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
                .addContainerGap())
        );
        jPanel7Layout.setVerticalGroup(jPanel7Layout.createParallelGroup(GroupLayout.Alignment.LEADING)
            .addGroup(jPanel7Layout.createSequentialGroup()
                .addContainerGap()
                .addComponent(jPanel1, GroupLayout.PREFERRED_SIZE, GroupLayout.DEFAULT_SIZE, GroupLayout.PREFERRED_SIZE)
                .addPreferredGap(LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(jPanel5, GroupLayout.PREFERRED_SIZE, GroupLayout.DEFAULT_SIZE, GroupLayout.PREFERRED_SIZE)
                .addContainerGap())
        );

        jToolBar1.setFloatable(false);

        buttonOpenTasks.setText("Open");
        buttonOpenTasks.setFocusable(false);
        buttonOpenTasks.setHorizontalTextPosition(SwingConstants.CENTER);
        buttonOpenTasks.setVerticalTextPosition(SwingConstants.BOTTOM);
        buttonOpenTasks.addMouseListener(new MouseAdapter() {
            public void mouseClicked(MouseEvent evt) {
                buttonOpenTasksMouseClicked(evt);
            }
        });
        jToolBar1.add(buttonOpenTasks);

        buttonSaveTasks.setText("Save");
        buttonSaveTasks.setEnabled(false);
        buttonSaveTasks.setFocusable(false);
        buttonSaveTasks.setHorizontalTextPosition(SwingConstants.CENTER);
        buttonSaveTasks.setVerticalTextPosition(SwingConstants.BOTTOM);
        buttonSaveTasks.addMouseListener(new MouseAdapter() {
            public void mouseClicked(MouseEvent evt) {
                buttonSaveTasksMouseClicked(evt);
            }
        });
        jToolBar1.add(buttonSaveTasks);

        buttonSaveTasksAs.setText("Save As");
        buttonSaveTasksAs.setFocusable(false);
        buttonSaveTasksAs.setHorizontalTextPosition(SwingConstants.CENTER);
        buttonSaveTasksAs.setVerticalTextPosition(SwingConstants.BOTTOM);
        buttonSaveTasksAs.addMouseListener(new MouseAdapter() {
            public void mouseClicked(MouseEvent evt) {
                buttonSaveTasksAsMouseClicked(evt);
            }
        });
        jToolBar1.add(buttonSaveTasksAs);
        jToolBar1.add(jSeparator2);

        buttonSetAuthor.setText("Set author");
        buttonSetAuthor.setFocusable(false);
        buttonSetAuthor.setHorizontalTextPosition(SwingConstants.CENTER);
        buttonSetAuthor.setVerticalTextPosition(SwingConstants.BOTTOM);
        buttonSetAuthor.addMouseListener(new MouseAdapter() {
            public void mouseClicked(MouseEvent evt) {
                buttonSetAuthorMouseClicked(evt);
            }
        });
        jToolBar1.add(buttonSetAuthor);
        jToolBar1.add(filler1);

        labelAuthorName.setText("Unkown author");
        jToolBar1.add(labelAuthorName);
        jToolBar1.add(jSeparator3);

        labelUnsavedChanges.setText("There are unsaved changes");
        labelUnsavedChanges.setEnabled(false);
        jToolBar1.add(labelUnsavedChanges);

        menuItemFile.setText("File");

        menuItemOpenFile.setText("Open");
        menuItemOpenFile.addMouseListener(new MouseAdapter() {
            public void mousePressed(MouseEvent evt) {
                menuItemOpenFileMousePressed(evt);
            }
        });
        menuItemFile.add(menuItemOpenFile);

        menuItemSaveTasks.setText("Save");
        menuItemSaveTasks.setEnabled(false);
        menuItemSaveTasks.addMouseListener(new MouseAdapter() {
            public void mouseClicked(MouseEvent evt) {
                menuItemSaveTasksMouseClicked(evt);
            }
        });
        menuItemFile.add(menuItemSaveTasks);

        menuItemSaveTasksAs.setText("Save As");
        menuItemSaveTasksAs.addMouseListener(new MouseAdapter() {
            public void mouseClicked(MouseEvent evt) {
                menuItemSaveTasksAsMouseClicked(evt);
            }
        });
        menuItemFile.add(menuItemSaveTasksAs);
        menuItemFile.add(jSeparator1);

        menuItemExit.setText("Exit");
        menuItemExit.addMouseListener(new MouseAdapter() {
            public void mousePressed(MouseEvent evt) {
                menuItemExitMousePressed(evt);
            }
        });
        menuItemFile.add(menuItemExit);

        jMenuBar1.add(menuItemFile);

        menuItemHelp.setText("Help");

        menuItemAbout.setText("About");
        menuItemAbout.addMouseListener(new MouseAdapter() {
            public void mousePressed(MouseEvent evt) {
                menuItemAboutMousePressed(evt);
            }
        });
        menuItemHelp.add(menuItemAbout);

        jMenuBar1.add(menuItemHelp);

        setJMenuBar(jMenuBar1);

        GroupLayout layout = new GroupLayout(getContentPane());
        getContentPane().setLayout(layout);
        layout.setHorizontalGroup(layout.createParallelGroup(GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addContainerGap()
                .addGroup(layout.createParallelGroup(GroupLayout.Alignment.LEADING)
                    .addComponent(jToolBar1, GroupLayout.DEFAULT_SIZE, GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                    .addComponent(textBoxError)
                    .addGroup(layout.createSequentialGroup()
                        .addComponent(jPanel3, GroupLayout.DEFAULT_SIZE, GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                        .addPreferredGap(LayoutStyle.ComponentPlacement.RELATED)
                        .addComponent(jPanel7, GroupLayout.PREFERRED_SIZE, GroupLayout.DEFAULT_SIZE, GroupLayout.PREFERRED_SIZE)))
                .addContainerGap())
        );
        layout.setVerticalGroup(layout.createParallelGroup(GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addContainerGap()
                .addComponent(jToolBar1, GroupLayout.PREFERRED_SIZE, 25, GroupLayout.PREFERRED_SIZE)
                .addPreferredGap(LayoutStyle.ComponentPlacement.RELATED)
                .addGroup(layout.createParallelGroup(GroupLayout.Alignment.LEADING)
                    .addComponent(jPanel7, GroupLayout.DEFAULT_SIZE, GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                    .addComponent(jPanel3, GroupLayout.DEFAULT_SIZE, GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
                .addPreferredGap(LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(textBoxError, GroupLayout.PREFERRED_SIZE, GroupLayout.DEFAULT_SIZE, GroupLayout.PREFERRED_SIZE))
        );

        pack();
    }// </editor-fold>//GEN-END:initComponents

	private void setTextToComponents() {
		Translate tr = Translate.getInstance();
		
		menuItemFile.setText(tr.menuItemFile);
		menuItemOpenFile.setText(tr.menuItemOpenFile);
		menuItemSaveTasks.setText(tr.menuItemSaveTasks);
		menuItemSaveTasksAs.setText(tr.menuItemSaveTasksAs);
		menuItemExit.setText(tr.menuItemExit);
		
		menuItemHelp.setText(tr.menuItemHelp);
		menuItemAbout.setText(tr.menuItemAbout);
		
		buttonNewTask.setText(tr.buttonNewTask);
		buttonRemoveTask.setText(tr.buttonRemove);
		buttonTaskUp.setText(tr.buttonUp);
		buttonTaskDown.setText(tr.buttonDown);
		buttonIncrPriority.setText("+ " + tr.buttonPriority);
		buttonDecrPriority.setText("- " + tr.buttonPriority);
		buttonShowAll.setText(tr.buttonShowAll);
		buttonHideAll.setText(tr.buttonHideAll);
		
		buttonTaskDone.setText(tr.buttonTaskDone);
		buttonTaskWorking.setText(tr.buttonTaskWorking);
		buttonTaskHold.setText(tr.buttonTaskHold);
		buttonTaskOnRevision.setText(tr.buttonTaskOnRevision);
		buttonTaskPendingRevision.setText(tr.buttonTaskPendingRevision);
		buttonTaskEdit.setText(tr.buttonTaskEdit);
		buttonTaskCancel.setText(tr.buttonTaskCancel);
		buttonTaskDelete.setText(tr.buttonTaskDelete);
		buttonTaskClear.setText(tr.buttonTaskClear);
		
		buttonOpenTasks.setText(tr.buttonOpenTasks);
		buttonSaveTasks.setText(tr.buttonSaveTasks);
		buttonSaveTasksAs.setText(tr.buttonSaveTasksAs);
		buttonSetAuthor.setText(tr.buttonSetAuthor);
		labelAuthorName.setText(tr.labelAuthorName);
		labelUnsavedChanges.setText(tr.labelUnsavedChanges);
		
		labelTaskName.setText(tr.labelTaskName);
		labelTaskAuthor.setText(tr.labelTaskAuthor);
		labelTaskDate.setText(tr.labelTaskDate);
		labelTaskDescription.setText(tr.labelTaskDescription);
		labelTaskHistory.setText(tr.labelTaskHistory);
		labelTaskStateText.setText(tr.labelTaskStateText);
		
		highPriorNode.setUserObject(tr.highPriorNode);
		medPriorNode.setUserObject(tr.medPriorNode);
		lowPriorNode.setUserObject(tr.lowPriorNode);
	}
	
	private void openLockFile(String basefile) {
		lockFileName = Tools.getLockFileName(basefile);
		
		log.info("Create a new lock file '" + lockFileName + "'");
		
		// open the lock file
		lockFile = new File(lockFileName);
		FileWriter fw;
		try {
			lockFile.createNewFile();
			fw = new FileWriter(lockFile, false);
			fw.write("Lock file for tasks file '" + basefile + "'.");
			fw.write("Created on " + Tools.getPrettyDate() + ".");
			fw.flush();
		}
		catch (IOException ex) {
			ex.printStackTrace();
			java.util.logging.Logger.getLogger(Logger.class.getName()).log(Level.SEVERE, null, ex);
		}
	}
	
	private void deleteLockFile() {
		if (lockFile != null) {
			log.info("Delete lock file '" + lockFileName + "'");
			lockFile.delete();
		}
	}
	
	private void setNodeExpandedState(DefaultMutableTreeNode node, boolean expanded) {
		ArrayList<DefaultMutableTreeNode> list = Collections.list(node.children());
		for (DefaultMutableTreeNode treeNode : list) {
			setNodeExpandedState(treeNode, expanded);
		}
		if (!expanded && node.isRoot()) {
			return;
		}
		TreePath path = new TreePath(node.getPath());
		if (expanded) {
			treeTasks.expandPath(path);
		}
		else {
			treeTasks.collapsePath(path);
		}
	}
	
	private void setTreeExpandedState(boolean expanded) {
		DefaultMutableTreeNode node = (DefaultMutableTreeNode) treeTasks.getModel().getRoot();
		setNodeExpandedState(node, expanded);
	}
	
	private void clearTextBoxError(int millis) {
		Timer t = new Timer(millis, new ActionListener() {
            @Override
            public void actionPerformed(ActionEvent e) {
                textBoxError.setText(null);
            }
        });
        t.setRepeats(false);
        t.start();
	}
	
	private void issueErrorMsg(String msg) {
		textBoxError.setText("Error: " + msg);
		log.error(msg);
		clearTextBoxError(20000);
	}
	
	private void issueWarningMsg(String msg) {
		textBoxError.setText("Warning: " + msg);
		log.warning(msg);
		clearTextBoxError(10000);
	}
	
	private void setChangesUnsaved() {
		changesSaved = false;
		Translate tr = Translate.getInstance();
		labelUnsavedChanges.setText(tr.labelUnsavedChanges);
		
		TaskManager tm = TaskManager.getInstance();
		if (!tm.getTaskFile().equals("")) {
			buttonSaveTasks.setEnabled(true);
			menuItemSaveTasks.setEnabled(true);
		}
	}
	
	private void setChangesSaved() {
		changesSaved = true;
		labelUnsavedChanges.setText("");
		buttonSaveTasks.setEnabled(false);
		menuItemSaveTasks.setEnabled(false);
	}
	private boolean areChangesSaved() { return changesSaved; }
	
	private void updateAuthor(String n) {
		authorName = n;
		labelAuthorName.setText(authorName);
		log.info("Author name changed to: '" + authorName + "'.");
	}
	private static String nullAuthorName() { return "??"; }
	private String getAuthorName() { return authorName == null ? nullAuthorName() : authorName; }
	private String requestAuthorName() {
		return JOptionPane.showInputDialog(this, Translate.getInstance().inputdialog_EnterAuthorName);
	}
	private void updateAuthorNameIfNone() {
		if (!getAuthorName().equals(nullAuthorName())) { return; }
		
		String n = requestAuthorName();
		if (n == null) {
			issueWarningMsg(Translate.getInstance().warning_AuthorNameNotSet);
		}
		else {
			updateAuthor(n);
		}
	}
	private void setNewAuthor() {
		authorName = requestAuthorName();
		updateAuthor(authorName);
	}
	
	private void overwriteChanges() {
		log.info("Saving tasks to disk");
		TaskManager tm = TaskManager.getInstance();
		tm.writeTasks(true); // do a backup
		log.info("Tasks created/edited so far have been saved to disk");
		setChangesSaved();
		// there is no need to manipulate the log files
	}
	
	private void openFile() {
		if (!areChangesSaved()) {
			promptSaveChanges();
		}
		
		// choose file
		log.info("Choosing file for opening...");
		
		JFileChooser fc = new JFileChooser();
		fc.setFileSelectionMode(JFileChooser.FILES_ONLY);
		fc.addChoosableFileFilter(new FileNameExtensionFilter("TodoListManager Documents", "tlm"));
		fc.setAcceptAllFileFilterUsed(true);
		
		int returnVal = fc.showOpenDialog(jPanel3);
        if (returnVal != JFileChooser.APPROVE_OPTION) {
            log.info("Open command cancelled by user.");
			return;
        }
		File file = fc.getSelectedFile();
		// this file already contains the '.tlm' at the end!
		// If not... blame the user!
		String newFileName = file.getAbsolutePath();
		
		// make sure the file chosen is not locked
		log.info("Checking whether file '" + newFileName + "' is locked...");
		if (Tools.fileExists(Tools.getLockFileName(newFileName))) {
			Translate tr = Translate.getInstance();
			String msg1 = tr.error_FileIsLocked1;
			String msg2 = tr.error_FileIsLocked1;
			issueErrorMsg(msg1 + " '" + newFileName + "' " + msg2 + ".");
			return;
		}
		log.info("    File is not locked.");
		
		TaskManager tm = TaskManager.getInstance();
		
		// do more work only if the file being opened
		// is different from the one we opened before
		if (tm.getTaskFile().equals(newFileName)) {
			log.warning("Trying to open the file you had already opened. Duh!");
			return;
		}
		
		// close the current lock file and open a new one
		deleteLockFile();
		openLockFile(newFileName);
		
		// read the chosen file
		log.info("Opening file '" + newFileName + "'.");
		tm.setTaskFile(newFileName);
		if (!tm.readTasks()) {
			issueErrorMsg(Translate.getInstance().error_CouldNotOpenFile + " '" + newFileName + "'.");
			return;
		}
		
		// clear tree...
		highPriorNode.removeAllChildren();
		medPriorNode.removeAllChildren();
		lowPriorNode.removeAllChildren();
		treeModel.reload();
		
		// fill tree...
		tm.getHighPriorTasks().forEach((t) -> { taskToNode(highPriorNode, t); });
		tm.getMedPriorTasks().forEach((t) -> { taskToNode(medPriorNode, t); });
		tm.getLowPriorTasks().forEach((t) -> { taskToNode(lowPriorNode, t); });
		treeModel.reload();
		// clear the text boxes
		clearBoxesTask();
		// expand the tree
		setTreeExpandedState(true);
		// technically, there are no changes so...
		setChangesSaved();
	}
	
	private void saveChangesAs() {
		// choose file
		log.info("Choosing file for saving...");
		
		JFileChooser fc = new JFileChooser();
		fc.setFileSelectionMode(JFileChooser.FILES_ONLY);
		fc.addChoosableFileFilter(new FileNameExtensionFilter("TodoListManager Documents", "tlm"));
		fc.setAcceptAllFileFilterUsed(true);
		
		int returnVal = fc.showSaveDialog(jPanel3);
        if (returnVal != JFileChooser.APPROVE_OPTION) {
            log.info("Save command cancelled by user");
			return;
        }
		File file = fc.getSelectedFile();
		String newFileName = file.getAbsolutePath() + ".tlm";
		buttonSaveTasks.setEnabled(true);
		
		TaskManager tm = TaskManager.getInstance();
		
		// save task
		log.info("Saving to file '" + newFileName + "'");
		boolean do_backup = true; // backup the currently opened file if necessary
		if (!tm.getTaskFile().equals(newFileName)) {
			// if the file is different, open and close lock file
			deleteLockFile();
			openLockFile(newFileName);
			
			// if the new file is different there
			// is no need to do a backup...
			do_backup = false;
			tm.setTaskFile(newFileName);
		}
		tm.writeTasks(do_backup);
		setChangesSaved();
	}
	
	// assuming there are unsaved changes...
	private void promptSaveChanges() {
		String task_file = TaskManager.getInstance().getTaskFile();
		boolean save_as = false;
		if (task_file.equals("")) {
			log.info("There are unsaved changes that need to be stored in a file");
			save_as = true;
		}
		
		Translate tr = Translate.getInstance();
		int response = JOptionPane.showConfirmDialog(
			null,
			tr.question_DoYouWantToSaveChanges,
			tr.dialogtitle_UnsavedChanges,
			JOptionPane.YES_NO_OPTION, JOptionPane.QUESTION_MESSAGE
		);
		
		boolean save = true;
		switch (response) {
			case JOptionPane.NO_OPTION:
			case JOptionPane.CLOSED_OPTION:
				save = false;
		}
		if (!save) {
			log.info("User does not want to save changes.... It's up to them...");
			return;
		}
		
		log.info("User wants to save changes");
		if (save_as) {
			log.info("Need a file");
			saveChangesAs();
			return;
		}
		overwriteChanges();
	}
	
	private String getPriority(DefaultMutableTreeNode n) {
		if (highPriorNode.isNodeDescendant(n)) { return "high"; }
		else if (medPriorNode.isNodeDescendant(n)) { return "med"; }
		else if (lowPriorNode.isNodeDescendant(n)) { return "low"; }
		issueErrorMsg(Translate.getInstance().error_CouldNotDetermineNodePrior);
		return "?";
	}
	
	private void refreshBoxesTask(Task t) {
		textBoxTaskName.setText(t.getName());
		textBoxTaskAuthor.setText(t.getCreator());
		labelTaskID.setText(t.getId());
		labelTaskState.setText(t.currentState().getState().toString());
		textBoxTaskDate.setText(t.getPrettyDate());
		textAreaTaskDescription.setText(t.getDescription());
		textAreaTaskChanges.setText(t.changesToString());
	}
	
	private void clearBoxesTask() {
		textBoxTaskName.setText("");
		textBoxTaskAuthor.setText("");
		labelTaskID.setText("000000");
		labelTaskState.setText("-");
		textBoxTaskDate.setText("");
		textAreaTaskDescription.setText("");
		textAreaTaskChanges.setText("");
	}
	
	private boolean treeHasSelection(String msg) {
		if (treeTasks.getSelectionCount() == 0) {
			issueErrorMsg(msg);
			return false;
		}
		return true;
	}
	
	private boolean treeHasSelection() {
		return treeTasks.getSelectionCount() > 0;
	}
	
    private void buttonTaskClearMouseClicked(MouseEvent evt) {//GEN-FIRST:event_buttonTaskClearMouseClicked
        clearBoxesTask();
    }//GEN-LAST:event_buttonTaskClearMouseClicked
	
    private void treeTasksValueChanged(TreeSelectionEvent evt) {//GEN-FIRST:event_treeTasksValueChanged
        if (!treeHasSelection()) { return; }
		DefaultMutableTreeNode sel
			= (DefaultMutableTreeNode) treeTasks.getLastSelectedPathComponent();
		if (sel.getLevel() <= 1) {
			// clear text boxes (nothing selected so nothing to show)
			clearBoxesTask();
			// disable edit button
			buttonTaskEdit.setEnabled(false);
			return;
		}
		Task node_task = (Task) sel.getUserObject();
		// fill in the text boxes
		refreshBoxesTask(node_task);
		// enable edit button
		buttonTaskEdit.setEnabled(true);
    }//GEN-LAST:event_treeTasksValueChanged

	private void moveTaskUpDown(String dir, int incr) {
		if (!treeHasSelection(Translate.getInstance().error_NeedTaskSelectedMove)) { return; }
		DefaultMutableTreeNode sel
			= (DefaultMutableTreeNode) treeTasks.getLastSelectedPathComponent();
		if (sel.getLevel() <= 1) {
			issueWarningMsg(Translate.getInstance().warning_CantMoveRootHighMedLow);
			return;
		}
		
		// the task associated to the node
		Task t = (Task) sel.getUserObject();
		
		log.info("Selected node (task id: '" + t.getId() + "' has level " + sel.getLevel() + ".");
		log.info("    Moving selection '" + dir + "' (by " + incr + ").");
		
		DefaultMutableTreeNode par_sel = (DefaultMutableTreeNode) sel.getParent();
		int idx = par_sel.getIndex(sel);
		if (dir.equals("up") && idx == 0) {
			issueWarningMsg(Translate.getInstance().warning_CantIncreasePriority);
			return;
		}
		if (dir.equals("down") && idx == par_sel.getChildCount() - 1) {
			issueWarningMsg(Translate.getInstance().warning_CantDecreasePriority);
			return;
		}
		
		log.info("    Selected node is the " + idx + "-th child of its parent.");
		
		// move the task inside the task manager
		if (sel.getLevel() == 2) {
			String prior = getPriority(sel);
			log.info("    Moving task of priority '" + prior + "' within the task manager.");
			TaskManager tm = TaskManager.getInstance();
			int i;
			if (prior.equals("high")) {
				i = tm.deleteHighTask(t.getId());
				tm.insertHighTask(i + incr, t);
			}
			else if (prior.equals("med")) {
				i = tm.deleteMedTask(t.getId());
				tm.insertMedTask(i + incr, t);
			}
			else if (prior.equals("low")) {
				i = tm.deleteLowTask(t.getId());
				tm.insertLowTask(i + incr, t);
			}
			else { return; }
			log.info("    Moved from position " + (i) + " to position " + (i + incr) + ".");
		}
		
		// if the task has a parent, move the subtask
		// within the parent's list of subtasks
		Task parent_task = t.getParentTask();
		if (parent_task != null) {
			log.info("    Moving task within the parent task's list of subtasks.");
			parent_task.moveSubtaskBy(t.getId(), incr);
		}
		
		// move the task in the tree
		treeModel.removeNodeFromParent(sel);
		par_sel.insert(sel, idx + incr);
		
		sel = (DefaultMutableTreeNode) par_sel.getChildAt(idx + incr);
		treeModel.reload(par_sel);
		treeTasks.expandPath(new TreePath(sel.getPath()));
		treeTasks.setSelectionPath(new TreePath(sel.getPath()));
		setChangesUnsaved();
	}
	
	private void changeTaskPriority(String dir, int incr) {
		if (!treeHasSelection(Translate.getInstance().error_NeedTaskSelectedMove)) {
			return;
		}
		updateAuthorNameIfNone();
		
		DefaultMutableTreeNode sel
			= (DefaultMutableTreeNode) treeTasks.getLastSelectedPathComponent();
		if (sel.getLevel() < 0) { return; }
		if (sel.getLevel() <= 1) {
			issueWarningMsg(Translate.getInstance().warning_CantMoveRootHighMedLow);
			return;
		}
		if (sel.getLevel() > 2) {
			issueWarningMsg(Translate.getInstance().warning_CantChangeTaskPriority);
			return;
		}
		
		String cur_prior = getPriority(sel);
		if (dir.equals("incr") && cur_prior.equals("high")) {
			issueWarningMsg(Translate.getInstance().warning_CantIncreasePriority);
			return;
		}
		if (dir.equals("decr") && cur_prior.equals("low")) {
			issueWarningMsg(Translate.getInstance().warning_CantDecreasePriority);
			return;
		}
		
		Task t = (Task) sel.getUserObject();
		TaskManager tm = TaskManager.getInstance();
		
		DefaultMutableTreeNode from_prior = null;
		DefaultMutableTreeNode to_prior = null;
		String verb = "";
		String new_prior = "??";
		
		if (cur_prior.equals("high")) {
			from_prior = highPriorNode;
			to_prior = medPriorNode;
			new_prior = "med";
			verb = "Decreased";
		}
		else if (cur_prior.equals("med")) {
			from_prior = medPriorNode;
			if (dir.equals("incr")) {
				to_prior = highPriorNode;
				new_prior = "high";
				verb = "Increased";
			}
			else if (dir.equals("decr")) {
				to_prior = lowPriorNode;
				new_prior = "low";
				verb = "Decreased";
			}
		}
		else if (cur_prior.equals("low")) {
			from_prior = lowPriorNode;
			to_prior = medPriorNode;
			new_prior = "medium";
			verb = "Increased";
		}
		else { return; }
		
		from_prior.remove(sel);
		to_prior.insert(sel, 0);
		
		if (cur_prior.equals("high"))     { tm.deleteHighTask(t.getId()); }
		else if (cur_prior.equals("med")) { tm.deleteMedTask(t.getId()); }
		else if (cur_prior.equals("low")) { tm.deleteLowTask(t.getId()); }
		
		if (new_prior.equals("high"))     { tm.insertHighTask(0, t); }
		else if (new_prior.equals("med")) { tm.insertMedTask(0, t); }
		else if (new_prior.equals("low")) { tm.insertLowTask(0, t); }
		
		t.changeState(
			getAuthorName(),
			verb + " priority to " + new_prior + ".",
			TaskStateEnum.PriorityChanged
		);
		
		refreshBoxesTask(t);
		treeModel.reload(from_prior);
		treeModel.reload(to_prior);
		treeTasks.expandPath(new TreePath(from_prior.getPath()));
		treeTasks.expandPath(new TreePath(to_prior.getPath()));
		treeTasks.expandPath(new TreePath(sel.getPath()));
		treeTasks.setSelectionPath(new TreePath(sel.getPath()));
		setChangesUnsaved();
	}
	
	// 'n' is the parent of task 't'
	private void taskToNode(DefaultMutableTreeNode n, Task t) {
		// make a new node, with associated task
		DefaultMutableTreeNode new_node = new DefaultMutableTreeNode(t);
		// insert node
		n.insert(new_node, n.getChildCount());
		// insert subtasks
		t.getSubtasks().forEach((st) -> { taskToNode(new_node, st); });
	}
	
    private void menuItemOpenFileMousePressed(MouseEvent evt) {//GEN-FIRST:event_menuItemOpenFileMousePressed
		openFile();
    }//GEN-LAST:event_menuItemOpenFileMousePressed

    private void buttonTaskEditMouseClicked(MouseEvent evt) {//GEN-FIRST:event_buttonTaskEditMouseClicked
        Translate tr = Translate.getInstance();
		if (!treeHasSelection(tr.error_NeedTaskSelectedEdit)) {
			return;
		}
		updateAuthorNameIfNone();
		
		DefaultMutableTreeNode sel
			= (DefaultMutableTreeNode) treeTasks.getLastSelectedPathComponent();
		
		if (sel.getLevel() == 1) {
			issueErrorMsg(Translate.getInstance().error_SelectionMustBeTask);
			return;
		}
		
		Task t = (Task) sel.getUserObject();
		// current task's name and description
		String prevName = t.getName();
		String prevDescr = t.getDescription();
		
		// prompt the user with an interface
		GUINewTask editTask = new GUINewTask();
		editTask.setTaskName(prevName);
		editTask.setTaskCreator(getAuthorName());
		editTask.setTaskDescription(prevDescr);
		Object[] button_options = {tr.GUIEditTask_buttonSaveEdits, tr.GUIEditTask_buttonCancelEdits};
		int res = JOptionPane.showOptionDialog(
			null, editTask,
			tr.dialogtitle_EditTask,
			JOptionPane.OK_CANCEL_OPTION, JOptionPane.PLAIN_MESSAGE,
			null, button_options, null
		);
		if (res != JOptionPane.OK_OPTION) {
			log.info("User cancelled edition of task.");
			return;
		}

		// new name and description
		t.setName(editTask.getTaskName());
		t.setDescription(editTask.getTaskDescription());
		// set the change to the task
		t.taskWasEdited(
			editTask.getTaskCreator(), "null",
			prevName, prevDescr, TaskStateEnum.Edited
		);
		
		refreshBoxesTask(t);
		
		// this edit jhas been written to the task, but not to the file
		setChangesUnsaved();
    }//GEN-LAST:event_buttonTaskEditMouseClicked

	/**
	 * Change a task's state.
	 * @param s The change of state of the task.
	 * @param use_reason Should I prompt the user for a reason?
	 */
	private void changeTaskState(TaskStateEnum s, boolean promptUser)
	{
		if (!treeHasSelection(Translate.getInstance().error_NeedTaskSelectedChangeState)) {
			return;
		}
		updateAuthorNameIfNone();
		
		DefaultMutableTreeNode sel
			= (DefaultMutableTreeNode) treeTasks.getLastSelectedPathComponent();
		Task t = (Task) sel.getUserObject();
		String r = t.askChangeState(s);
		if (!r.equals("")) {
			Translate tr = Translate.getInstance();
			String msg1 = tr.getInstance().error_CantChangeTaskState1;
			String msg2 = tr.getInstance().error_CantChangeTaskState2;
			issueErrorMsg(msg1 + " (id: " + t.getId() + ") " + msg2 + ": " + r);
			return;
		}
		String reason = null;
		if (promptUser) {
			Translate tr = Translate.getInstance();
			reason = JOptionPane.showInputDialog(
				null,
				tr.question_WhyChangeTaskState,
				tr.dialogtitle_ChangeTaskState,
				JOptionPane.PLAIN_MESSAGE // no icon
			);
		}
		t.changeState(getAuthorName(), reason, s);
		refreshBoxesTask(t);
		treeModel.reload(sel);
		setChangesUnsaved();
	}
	
    private void buttonTaskDoneMouseClicked(MouseEvent evt) {//GEN-FIRST:event_buttonTaskDoneMouseClicked
        changeTaskState(TaskStateEnum.Done, false);
    }//GEN-LAST:event_buttonTaskDoneMouseClicked

    private void buttonTaskWorkingMouseClicked(MouseEvent evt) {//GEN-FIRST:event_buttonTaskWorkingMouseClicked
        changeTaskState(TaskStateEnum.Working, false);
    }//GEN-LAST:event_buttonTaskWorkingMouseClicked

    private void buttonTaskHoldMouseClicked(MouseEvent evt) {//GEN-FIRST:event_buttonTaskHoldMouseClicked
        changeTaskState(TaskStateEnum.PutOnHold, true);
    }//GEN-LAST:event_buttonTaskHoldMouseClicked

    private void buttonTaskOnRevisionMouseClicked(MouseEvent evt) {//GEN-FIRST:event_buttonTaskOnRevisionMouseClicked
        changeTaskState(TaskStateEnum.OnRevision, false);
    }//GEN-LAST:event_buttonTaskOnRevisionMouseClicked

    private void buttonTaskPendingRevisionMouseClicked(MouseEvent evt) {//GEN-FIRST:event_buttonTaskPendingRevisionMouseClicked
        changeTaskState(TaskStateEnum.PendingRevision, true);
    }//GEN-LAST:event_buttonTaskPendingRevisionMouseClicked

    private void buttonTaskCancelMouseClicked(MouseEvent evt) {//GEN-FIRST:event_buttonTaskCancelMouseClicked
        changeTaskState(TaskStateEnum.Cancelled, true);
    }//GEN-LAST:event_buttonTaskCancelMouseClicked

    private void buttonTaskDeleteMouseClicked(MouseEvent evt) {//GEN-FIRST:event_buttonTaskDeleteMouseClicked
        changeTaskState(TaskStateEnum.Deleted, true);
    }//GEN-LAST:event_buttonTaskDeleteMouseClicked

    private void menuItemAboutMousePressed(MouseEvent evt) {//GEN-FIRST:event_menuItemAboutMousePressed
        GUIAbout paneAbout = new GUIAbout();
		JDialog dialogAbout = new JDialog(this, Translate.getInstance().dialogtitle_About);
		dialogAbout.add(paneAbout);
		dialogAbout.setSize(750, 570);
		dialogAbout.setResizable(false);
		dialogAbout.setVisible(true);
		
    }//GEN-LAST:event_menuItemAboutMousePressed

    private void formWindowClosing(WindowEvent evt) {//GEN-FIRST:event_formWindowClosing
        if (!areChangesSaved()) {
			promptSaveChanges();
		}
		deleteLockFile();
		log.info("Closing TodoListManager...");
		log.end();
    }//GEN-LAST:event_formWindowClosing

    private void menuItemExitMousePressed(MouseEvent evt) {//GEN-FIRST:event_menuItemExitMousePressed
		dispatchEvent(new WindowEvent(this, WindowEvent.WINDOW_CLOSING));
    }//GEN-LAST:event_menuItemExitMousePressed

    private void buttonSaveTasksAsMouseClicked(MouseEvent evt) {//GEN-FIRST:event_buttonSaveTasksAsMouseClicked
        saveChangesAs();
    }//GEN-LAST:event_buttonSaveTasksAsMouseClicked

    private void buttonSaveTasksMouseClicked(MouseEvent evt) {//GEN-FIRST:event_buttonSaveTasksMouseClicked
        if (buttonSaveTasks.isEnabled()) {
			overwriteChanges();
		}
    }//GEN-LAST:event_buttonSaveTasksMouseClicked

    private void buttonOpenTasksMouseClicked(MouseEvent evt) {//GEN-FIRST:event_buttonOpenTasksMouseClicked
        openFile();
    }//GEN-LAST:event_buttonOpenTasksMouseClicked

    private void menuItemSaveTasksAsMouseClicked(MouseEvent evt) {//GEN-FIRST:event_menuItemSaveTasksAsMouseClicked
        if (menuItemSaveTasksAs.isEnabled()) {
			saveChangesAs();
		}
    }//GEN-LAST:event_menuItemSaveTasksAsMouseClicked

    private void menuItemSaveTasksMouseClicked(MouseEvent evt) {//GEN-FIRST:event_menuItemSaveTasksMouseClicked
		if (menuItemSaveTasks.isEnabled()) {
			overwriteChanges();
		}
    }//GEN-LAST:event_menuItemSaveTasksMouseClicked

    private void buttonSetAuthorMouseClicked(MouseEvent evt) {//GEN-FIRST:event_buttonSetAuthorMouseClicked
		setNewAuthor();
    }//GEN-LAST:event_buttonSetAuthorMouseClicked

    private void buttonHideAllMouseClicked(MouseEvent evt) {//GEN-FIRST:event_buttonHideAllMouseClicked
        setTreeExpandedState(false);
    }//GEN-LAST:event_buttonHideAllMouseClicked

    private void buttonShowAllMouseClicked(MouseEvent evt) {//GEN-FIRST:event_buttonShowAllMouseClicked
        setTreeExpandedState(true);
    }//GEN-LAST:event_buttonShowAllMouseClicked

    private void buttonDecrPriorityMouseClicked(MouseEvent evt) {//GEN-FIRST:event_buttonDecrPriorityMouseClicked
        changeTaskPriority("decr", +1);
    }//GEN-LAST:event_buttonDecrPriorityMouseClicked

    private void buttonIncrPriorityMouseClicked(MouseEvent evt) {//GEN-FIRST:event_buttonIncrPriorityMouseClicked
        changeTaskPriority("incr", -1);
    }//GEN-LAST:event_buttonIncrPriorityMouseClicked

    private void buttonTaskUpMouseClicked(MouseEvent evt) {//GEN-FIRST:event_buttonTaskUpMouseClicked
        moveTaskUpDown("up", -1);
    }//GEN-LAST:event_buttonTaskUpMouseClicked

    private void buttonTaskDownMouseClicked(MouseEvent evt) {//GEN-FIRST:event_buttonTaskDownMouseClicked
        moveTaskUpDown("down", +1);
    }//GEN-LAST:event_buttonTaskDownMouseClicked

    private void buttonNewTaskMouseClicked(MouseEvent evt) {//GEN-FIRST:event_buttonNewTaskMouseClicked
        if (treeTasks.getSelectionCount() == 0) {
            issueWarningMsg(Translate.getInstance().warning_CantAddTask);
            return;
        }

        updateAuthorNameIfNone();
        Translate tr = Translate.getInstance();

        // prompt the user with an interface
        GUINewTask makeTask = new GUINewTask();
        makeTask.setTaskCreator(getAuthorName());
        Object[] button_options = {tr.GUINewTask_buttonCreateTask, tr.GUINewTask_buttonCancel};
        int res = JOptionPane.showOptionDialog(
            null, makeTask,
            Translate.getInstance().dialogtitle_CreateNewTask,
            JOptionPane.OK_CANCEL_OPTION, JOptionPane.PLAIN_MESSAGE,
            null, button_options, null
        );
        if (res != JOptionPane.OK_OPTION) {
            log.info("User cancelled creation of new task.");
            return;
        }

        // get data used to identify the task
        String taskName = makeTask.getTaskName();
        String taskCreator = makeTask.getTaskCreator();
        String taskDescr = makeTask.getTaskDescription();

        log.info("New task:");
        log.info("    Name: " + taskName + ".");
        log.info("    Creator: " + taskCreator + ".");
        log.info("    Description: " + taskDescr + ".");

        // find out if the task is high/med/low
        DefaultMutableTreeNode sel
        = (DefaultMutableTreeNode) treeTasks.getLastSelectedPathComponent();

        if (taskName.equals("")) {
            taskName = "Nameless task";
            log.info("No name for new task.");
        }
        if (taskDescr.equals("")) {
            taskDescr = "Empty task (yay! nothing to do!)";
            log.info("No description for new task.");
        }

        // create the task
        TaskManager tm = TaskManager.getInstance();
        Task new_t = tm.newTask(taskCreator, taskName, taskDescr);

        // the task should only be added to the taks manager's
        // containers if they are children of the "high/med/low" nodes.
        if (sel.getLevel() == 1) {
            String prior = getPriority(sel);
            if (prior.equals("high")) { tm.insertHighTask(0, new_t); }
            else if (prior.equals("med")) { tm.insertMedTask(0, new_t); }
            else if (prior.equals("low")) { tm.insertLowTask(0, new_t); }
            else { return; }
        }

        // is this new task a subtask? the selection is a task,
        // so the new task is actually a subtask!
        if (sel.getLevel() > 1) {
            // the task associated to the selected node
            Task node_task = (Task) sel.getUserObject();
            // add the new task as a subtask
            node_task.addSubtask(new_t);
            // change state
            String m = "A subtask was added (id: " + new_t.getId() + ")";
            node_task.changeState(taskCreator, m, TaskStateEnum.AddedSubtask);
            // fill in the text boxes
            refreshBoxesTask(node_task);
        }

        // make the node so as to show it to the user
        DefaultMutableTreeNode new_node = new DefaultMutableTreeNode(new_t);
        sel.insert(new_node, 0);
        treeModel.reload(sel);
        treeTasks.expandPath(new TreePath(sel.getPath()));
        treeTasks.setSelectionPath(new TreePath(new_node.getPath()));
        setChangesUnsaved();
    }//GEN-LAST:event_buttonNewTaskMouseClicked

    private void buttonRemoveTaskMouseClicked(MouseEvent evt) {//GEN-FIRST:event_buttonRemoveTaskMouseClicked
        if (!treeHasSelection(Translate.getInstance().error_NeedTaskSelectedDelete)) { return; }

        DefaultMutableTreeNode sel
        = (DefaultMutableTreeNode) treeTasks.getLastSelectedPathComponent();
        if (sel.getLevel() <= 1) {
            issueWarningMsg(Translate.getInstance().warning_CantDeleteRootHighMedLow);
            return;
        }

        TaskManager tm = TaskManager.getInstance();
        Task node_task = (Task) sel.getUserObject();
        boolean d = tm.deleteTask(node_task.getId());
        if (!d) {
            log.info("Attempted at removing a subtask from the task manager");
            log.info("    Subtasks are never added at the manager");
        }

        DefaultMutableTreeNode par_sel
        = (DefaultMutableTreeNode) treeTasks.getLastSelectedPathComponent();
        treeModel.removeNodeFromParent(sel);
        treeModel.reload(par_sel);
        setChangesUnsaved();
    }//GEN-LAST:event_buttonRemoveTaskMouseClicked

	/**
	 * @param args the command line arguments
	 */
	public static void main(String args[]) {
		/* Set the Nimbus look and feel */
		//<editor-fold defaultstate="collapsed" desc=" Look and feel setting code (optional) ">
		/* If Nimbus (introduced in Java SE 6) is not available, stay with the default look and feel.
         * For details see http://download.oracle.com/javase/tutorial/uiswing/lookandfeel/plaf.html 
		 */
		try {
			for (javax.swing.UIManager.LookAndFeelInfo info : javax.swing.UIManager.getInstalledLookAndFeels()) {
				if ("Nimbus".equals(info.getName())) {
					javax.swing.UIManager.setLookAndFeel(info.getClassName());
					break;
				}
			}
		} catch (ClassNotFoundException ex) {
			java.util.logging.Logger.getLogger(MainView.class.getName()).log(java.util.logging.Level.SEVERE, null, ex);
		} catch (InstantiationException ex) {
			java.util.logging.Logger.getLogger(MainView.class.getName()).log(java.util.logging.Level.SEVERE, null, ex);
		} catch (IllegalAccessException ex) {
			java.util.logging.Logger.getLogger(MainView.class.getName()).log(java.util.logging.Level.SEVERE, null, ex);
		} catch (javax.swing.UnsupportedLookAndFeelException ex) {
			java.util.logging.Logger.getLogger(MainView.class.getName()).log(java.util.logging.Level.SEVERE, null, ex);
		}
		//</editor-fold>

		/* Create and display the form */
		java.awt.EventQueue.invokeLater(new Runnable() {
			public void run() {
				new MainView().setVisible(true);
			}
		});
	}

    // Variables declaration - do not modify//GEN-BEGIN:variables
    private JButton buttonDecrPriority;
    private JButton buttonHideAll;
    private JButton buttonIncrPriority;
    private JButton buttonNewTask;
    private JButton buttonOpenTasks;
    private JButton buttonRemoveTask;
    private JButton buttonSaveTasks;
    private JButton buttonSaveTasksAs;
    private JButton buttonSetAuthor;
    private JButton buttonShowAll;
    private JButton buttonTaskCancel;
    private JButton buttonTaskClear;
    private JButton buttonTaskDelete;
    private JButton buttonTaskDone;
    private JButton buttonTaskDown;
    private JButton buttonTaskEdit;
    private JButton buttonTaskHold;
    private JButton buttonTaskOnRevision;
    private JButton buttonTaskPendingRevision;
    private JButton buttonTaskUp;
    private JButton buttonTaskWorking;
    private Box.Filler filler1;
    private JLabel jLabel6;
    private JMenuBar jMenuBar1;
    private JPanel jPanel1;
    private JPanel jPanel2;
    private JPanel jPanel3;
    private JPanel jPanel5;
    private JPanel jPanel7;
    private JScrollPane jScrollPane1;
    private JScrollPane jScrollPane6;
    private JScrollPane jScrollPane7;
    private JPopupMenu.Separator jSeparator1;
    private JToolBar.Separator jSeparator2;
    private JToolBar.Separator jSeparator3;
    private JToolBar jToolBar1;
    private JLabel labelAuthorName;
    private JLabel labelTaskAuthor;
    private JLabel labelTaskDate;
    private JLabel labelTaskDescription;
    private JLabel labelTaskHistory;
    private JLabel labelTaskID;
    private JLabel labelTaskName;
    private JLabel labelTaskState;
    private JLabel labelTaskStateText;
    private JLabel labelUnsavedChanges;
    private JMenuItem menuItemAbout;
    private JMenuItem menuItemExit;
    private JMenu menuItemFile;
    private JMenu menuItemHelp;
    private JMenuItem menuItemOpenFile;
    private JMenuItem menuItemSaveTasks;
    private JMenuItem menuItemSaveTasksAs;
    private JTextArea textAreaTaskChanges;
    private JTextArea textAreaTaskDescription;
    private JTextField textBoxError;
    private JTextField textBoxTaskAuthor;
    private JTextField textBoxTaskDate;
    private JTextField textBoxTaskName;
    private JTree treeTasks;
    // End of variables declaration//GEN-END:variables

}
